# The MSYS shell will cd to $HOME when it starts due to --login. But we want
# to stay in the current working directory. So set home to here. Also, we must
# set MSYSTEM to get MSYS64. Without this the value of PKG_CONFIG_PATH, which
# is set by sh.exe when it executes /etc/profile due to --login, does not
# point to the directories where the mingw-w64-x86_64-* packages store their
# info.
environment:
  HOME: C:\projects\pris
  MSYSTEM: MINGW64

install:
  # Download the Rust and Cargo installer.
  - ps: Start-FileDownload "https://static.rust-lang.org/dist/rust-1.17.0-x86_64-pc-windows-gnu.msi"

  # Install Rust and Cargo and wait for installation to finish by using Write-Output.
  - ps: msiexec /package "rust-1.17.0-x86_64-pc-windows-gnu.msi" /quiet /norestart | Write-Output

  # Pick up the new Path variable after the installer modified it.
  - ps: $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine")

  # Print versions for future reference.
  - rustc --version
  - cargo --version

before_build:
  - C:\msys64\usr\bin\sh.exe --login /c/projects/pris/build_msys.sh install_deps

build_script:
  - C:\msys64\usr\bin\sh.exe --login /c/projects/pris/build_msys.sh cargo_build
  - C:\msys64\usr\bin\sh.exe --login /c/projects/pris/build_msys.sh copy_deps

test_script:
  - C:\msys64\usr\bin\sh.exe --login /c/projects/pris/build_msys.sh cargo_test

  # Do a dry run outside of the MSYS shell. Pass --help to ensure a clean exit.
  - target\debug\pris.exe --help
